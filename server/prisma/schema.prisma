// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  // ak chceš, pridaj:
  // output = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/**
 * ============================
 * ENUMS
 * ============================
 */

enum LobbyMode {
  random
  friend
  bot
}

enum LobbyStatus {
  waiting
  starting
  in_progress
  completed
  cancelled
}

enum SessionStatus {
  waiting
  active
  completed
  cancelled
  expired
}

enum PlayerMatchResult {
  win
  lose
  disconnect
  timeout
}

enum ReferralStatus {
  pending
  active
  inactive
}

enum AmbassadorTier {
  bronze
  silver
  gold
}

enum RewardType {
  reflex_points
  sol_bonus
}

/**
 * ============================
 * USER & CORE ENTITIES
 * ============================
 */

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  walletAddress String?  @unique
  avatar        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Lobbies & sessions
  createdLobbies GameLobby[]   @relation("LobbyCreator")
  lobbyPlayers   LobbyPlayer[]
  sessionsWon    GameSession[] @relation("SessionWinner")
  gamePlayers    GamePlayer[]

  // Game results (for history / stats)
  gameResultsWon  GameResult[] @relation("ResultWinner")
  gameResultsLost GameResult[] @relation("ResultLoser")

  // Stats / leaderboards
  stats              PlayerStats?
  leaderboardEntries LeaderboardEntry[]

  // Daily / weekly rewards
  dailyChallenge DailyChallengeProgress?
  weeklyStreak   WeeklyStreak?

  // Referrals & ambassador
  ambassadorProfile  AmbassadorProfile?
  referralsMade      Referral[]         @relation("Referrer")
  referralsReceived  Referral[]         @relation("Referred")
  referralRewardsOut ReferralReward[]   @relation("ReferrerRewards")
  referralRewardsIn  ReferralReward[]   @relation("ReferredRewards")
}

/**
 * ============================
 * GAME LOBBY / SESSION / MATCH
 * ============================
 */

model GameLobby {
  id        String      @id @default(uuid())
  code      String?     @unique
  mode      LobbyMode
  status    LobbyStatus @default(waiting)
  bestOf    Int         @default(1)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  creatorId String
  creator   User   @relation("LobbyCreator", fields: [creatorId], references: [id])

  players  LobbyPlayer[]
  sessions GameSession[]
}

model LobbyPlayer {
  id         String    @id @default(uuid())
  lobbyId    String
  userId     String
  joinedAt   DateTime  @default(now())
  leftAt     DateTime?
  seatNumber Int?
  isReady    Boolean   @default(false)
  isCreator  Boolean   @default(false)

  lobby GameLobby @relation(fields: [lobbyId], references: [id])
  user  User      @relation(fields: [userId], references: [id])

  @@unique([lobbyId, userId])
}

model GameSession {
  id          String        @id @default(uuid())
  lobbyId     String
  roundNumber Int           @default(1)
  status      SessionStatus @default(waiting)
  startedAt   DateTime?
  endedAt     DateTime?

  winnerId String?
  winner   User?   @relation("SessionWinner", fields: [winnerId], references: [id])

  lobby   GameLobby   @relation(fields: [lobbyId], references: [id])
  matches GameMatch[]
}

model GameMatch {
  id            String    @id @default(uuid())
  sessionId     String
  mode          LobbyMode // random / friend / bot
  targetShape   String?
  targetColor   String?
  createdAt     DateTime  @default(now())
  startedAt     DateTime?
  targetShownAt DateTime?
  completedAt   DateTime?

  // víťaz v rámci tohto matchu
  winningPlayerId String?
  winningPlayer   GamePlayer? @relation("MatchWinner", fields: [winningPlayerId], references: [id])

  session GameSession  @relation(fields: [sessionId], references: [id])
  players GamePlayer[]
  result  GameResult?
}

model GamePlayer {
  id         String             @id @default(uuid())
  matchId    String
  userId     String?
  isBot      Boolean            @default(false)
  reactionMs Int?
  result     PlayerMatchResult?
  createdAt  DateTime           @default(now())

  match GameMatch @relation(fields: [matchId], references: [id])
  user  User?     @relation(fields: [userId], references: [id])

  // spätná väzba pre víťazné zápasy
  winningMatches GameMatch[] @relation("MatchWinner")
}

model GameResult {
  id               String   @id @default(uuid())
  matchId          String   @unique
  winnerId         String?
  loserId          String?
  winnerReactionMs Int?
  loserReactionMs  Int?
  createdAt        DateTime @default(now())

  match  GameMatch @relation(fields: [matchId], references: [id])
  winner User?     @relation("ResultWinner", fields: [winnerId], references: [id])
  loser  User?     @relation("ResultLoser", fields: [loserId], references: [id])
}

/**
 * ============================
 * STATS & LEADERBOARD
 * ============================
 */

model PlayerStats {
  id                String   @id @default(uuid())
  userId            String   @unique
  totalMatches      Int      @default(0)
  totalWins         Int      @default(0)
  totalLosses       Int      @default(0)
  winRate           Float    @default(0)
  bestReactionMs    Int?
  averageReactionMs Float?
  currentStreak     Int      @default(0)
  bestStreak        Int      @default(0)
  totalReflexPoints Int      @default(0)
  // tieto dve sú len štatistické agregáty (čítané z on-chain / indexera),
  // backend z nich nikdy nerobí "source of truth" pre peniaze
  totalSolWagered   Decimal  @default(0) @db.Decimal(18, 6)
  totalSolWon       Decimal  @default(0) @db.Decimal(18, 6)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model LeaderboardEntry {
  id            String   @id @default(uuid())
  userId        String
  snapshotDate  DateTime @default(now())
  rating        Int      @default(0)
  rank          Int?
  matchesPlayed Int      @default(0)
  wins          Int      @default(0)

  user User @relation(fields: [userId], references: [id])

  @@index([snapshotDate], name: "LeaderboardEntry_snapshotDate_idx")
}

/**
 * ============================
 * DAILY / WEEKLY REWARDS
 * ============================
 */

model DailyChallengeProgress {
  id            String   @id @default(uuid())
  userId        String   @unique
  date          DateTime // normalized day (UTC) – 1 záznam na deň
  matchesPlayed Int      @default(0) // cieľ: 5
  completed     Boolean  @default(false) // true, ak matchesPlayed >= 5
  rewardClaimed Boolean  @default(false) // true, ak dostal 10 Reflex points
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([date], name: "DailyChallengeProgress_date_idx")
}

model WeeklyStreak {
  id                  String    @id @default(uuid())
  userId              String    @unique
  currentStreakDays   Int       @default(0) // počet dní v rade s completed daily
  lastActiveDate      DateTime?
  weekStartDate       DateTime?
  weekEndDate         DateTime?
  weeklyRewardClaimed Boolean   @default(false) // true, ak dostal 50 Reflex points
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])
}

/**
 * ============================
 * REFERRALS & AMBASSADORS
 * ============================
 */

model Referral {
  id            String         @id @default(uuid())
  referrerId    String
  referredId    String
  status        ReferralStatus @default(pending)
  createdAt     DateTime       @default(now())
  activatedAt   DateTime?
  deactivatedAt DateTime?

  referrer User @relation("Referrer", fields: [referrerId], references: [id])
  referred User @relation("Referred", fields: [referredId], references: [id])

  rewards ReferralReward[]

  @@unique([referrerId, referredId])
}

model AmbassadorProfile {
  id                String         @id @default(uuid())
  userId            String         @unique
  code              String         @unique
  tier              AmbassadorTier @default(bronze)
  totalReferrals    Int            @default(0)
  activeReferrals   Int            @default(0)
  totalReflexEarned Int            @default(0)
  totalSolBonus     Decimal        @default(0) @db.Decimal(18, 6)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  user    User             @relation(fields: [userId], references: [id])
  rewards ReferralReward[]
}

model ReferralReward {
  id        String     @id @default(uuid())
  type      RewardType
  amount    Decimal    @db.Decimal(18, 6) // pri reflex_points interpretuj ako počet bodov
  createdAt DateTime   @default(now())

  // kto dostal reward (referrer/ambassador)
  referrerId String
  referrer   User   @relation("ReferrerRewards", fields: [referrerId], references: [id])

  // za koho bol reward (optional)
  referredId String?
  referred   User?   @relation("ReferredRewards", fields: [referredId], references: [id])

  ambassadorId String?
  ambassador   AmbassadorProfile? @relation(fields: [ambassadorId], references: [id])
  referral     Referral?          @relation(fields: [referralId], references: [id])
  referralId   String?
}
