// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * ============================
 * ENUMS
 * ============================
 */

enum MatchType {
  friend
  ranked
}

enum SessionStatus {
  active      // Hra práve prebieha
  completed   // Riadne dokončená
  cancelled   // Zrušená (napr. timeout v lobby)
  disputed    // Problém (napr. disconnect oboch)
}

enum RoundResult {
  win
  lose
  draw
}

enum AmbassadorTier {
  bronze
  silver
  gold
}

enum ReferralStatus {
  pending
  active
  inactive
}

enum TransactionType {
  deposit
  withdrawal
  game_stake     // Strhnutie stávky pred hrou
  game_payout    // Výhra po hre
  game_refund    // Vrátenie stávky (pri zrušení)
  referral_bonus // Odmena pre ambasádora
  challenge_reward // Odmena za daily challenge
}

enum TransactionStatus {
  pending
  confirmed
  failed
}

/**
 * ============================
 * USER & CORE
 * ============================
 */

model User {
  id            String    @id @default(uuid())
  walletAddress String    @unique
  username      String?   @unique
  avatar        String?
  ipAddress     String?   // Security & Anti-cheat
  
  createdAt     DateTime  @default(now())
  lastSessionAt DateTime? @updatedAt

  // --- Relácie ---

  // Financie
  transactions      Transaction[]

  // Hra
  sessionsWon       GameSession[] @relation("SessionWinner")
  sessionsLost      GameSession[] @relation("SessionLoser")

  // Štatistiky a Odmeny
  stats             PlayerStats?
  rewards           PlayerRewards?
  
  // Rebríčky
  leaderboardEntries LeaderboardPlayer[]

  // Referral systém
  ambassadorProfile AmbassadorProfile?
  referrals         Referral[]               @relation("ReferredUser") // Kto ma odporučil (som referred)
  
  // Gamifikácia
  dailyChallengeProgress DailyChallengeProgress[]
  weeklyStreaks          WeeklyStreak[]

  @@index([walletAddress])
  @@index([username])
}

/**
 * ============================
 * FINANCE & TRANSACTIONS
 * ============================
 */

model Transaction {
  id            String            @id @default(uuid())
  userId        String
  gameSessionId String?           // Link na hru, ak ide o stake/payout
  
  amount        Decimal           @db.Decimal(18, 9) // Presnosť na Lamports
  type          TransactionType
  status        TransactionStatus @default(pending)
  signature     String?           @unique // Hash transakcie na Solane
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user          User         @relation(fields: [userId], references: [id])
  gameSession   GameSession? @relation(fields: [gameSessionId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([status])
}

/**
 * ============================
 * GAMEPLAY
 * ============================
 */

model GameSession {
  id            String        @id @default(uuid())
  totalRounds   Int           @default(0)
  status        SessionStatus @default(active)
  matchType     MatchType
  
  winnerId      String?       // Nullable, lebo pri 'active' ešte nevieme víťaza
  loserId       String?

  // Stats
  avgWinnerReaction Decimal?  @db.Decimal(10, 2)
  avgLoserReaction  Decimal?  @db.Decimal(10, 2)
  
  // Economy
  stakeWinner   Decimal       @default(0) @db.Decimal(18, 9)
  stakeLoser    Decimal       @default(0) @db.Decimal(18, 9)
  payout        Decimal       @default(0) @db.Decimal(18, 9)

  // Scores
  winnerScore   Int           @default(0)
  loserScore    Int           @default(0)
  
  snapshotDate  DateTime      @default(now())
 
  // Relations
  winner        User?         @relation("SessionWinner", fields: [winnerId], references: [id])
  loser         User?         @relation("SessionLoser", fields: [loserId], references: [id])
  rounds        GameRound[]
  transactions  Transaction[]

  @@index([winnerId])
  @@index([loserId])
  @@index([snapshotDate]) // Pre filtrovanie histórie podľa dátumu
}

model GameRound {
  gameSessionId   String
  roundNumber     Int
  
  winnerId        String?     // ID hráča, ktorý vyhral kolo
  loserId         String?     // ID porazeného v kole
  winnerReaction  Int?        // ms
  loserReaction   Int?        // ms
   
  createdAt       DateTime    @default(now())

  session         GameSession @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)
  @@id([gameSessionId, roundNumber])
}

/**
 * ============================
 * PLAYER DATA & STATS
 * ============================
 */

model PlayerStats {
  userId               String   @id
  
  totalMatches         Int      @default(0)
  totalWins            Int      @default(0)
  totalLosses          Int      @default(0)
  winRate              Decimal  @default(0) @db.Decimal(5, 2) // %
  
  bestReaction         Decimal  @default(9999) @db.Decimal(10, 2) // ms (init s vysokou hodnotou)
  avgReaction          Decimal  @default(0) @db.Decimal(10, 2) // ms
  
  totalVolumeSolPlayed Decimal  @default(0) @db.Decimal(18, 9)
  totalSolWon          Decimal  @default(0) @db.Decimal(18, 9)
  totalSolLost         Decimal  @default(0) @db.Decimal(18, 9)
  
  lastUpdated          DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model PlayerRewards {
  userId           String  @id
  
  reflexPoints     Int     @default(0)
  totalFreeStakes  Int     @default(0)
  
  // Konkrétne typy free stakes
  freeStakes05Sol  Int     @default(0)
  freeStakes01Sol  Int     @default(0)
  freeStakes02Sol  Int     @default(0)
  
  dailyStreak      Int     @default(0)
  lastStreakUpdate DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ============================
 * LEADERBOARDS (Snapshots)
 * ============================
 */

model LeaderboardPlayer {
  userId               String   // Môže byť unique ak je to "aktuálny" leaderboard
  position             Int
  
  avgReaction          Decimal  @db.Decimal(10, 2)
  matchesPlayed        Int
  wins                 Int
  totalSolWon          Decimal  @db.Decimal(18, 9)
  totalVolumeSolPlayed Decimal  @db.Decimal(18, 9)
  
  snapshotDate         DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  
  @@id([userId, snapshotDate])
  @@index([snapshotDate])
  @@index([position])
}

model LeaderboardAmbassador {
  userId          String
  tier            AmbassadorTier
  activeReferrals Int
  snapshotDate    DateTime       @default(now())

  @@id([userId, snapshotDate])
  @@index([snapshotDate])
}

/**
 * ============================
 * AMBASSADOR & REFERRALS
 * ============================
 */

model AmbassadorProfile {
  userId          String         @id
  code            String         @unique // Referral kód (napr. "REFLEX_KING")
  tier            AmbassadorTier @default(bronze)
  
  totalInvited    Int            @default(0)
  activeReferrals Int            @default(0) // Počet hráčov, ktorí odohrali aspoň X hier
  
  updatedAt       DateTime       @updatedAt

  user      User       @relation(fields: [userId], references: [id])
  referrals Referral[]
}

model Referral {
  ambassadorId String
  referredId   String         @id
  
  totalMatches Int            @default(0) // Sledujeme aktivitu pre vyplatenie odmeny
  status       ReferralStatus @default(pending)
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  ambassador   AmbassadorProfile @relation(fields: [ambassadorId], references: [userId])
  referred     User              @relation("ReferredUser", fields: [referredId], references: [id])

  @@index([ambassadorId])
  @@index([referredId])
}

/**
 * ============================
 * CHALLENGES & STREAKS
 * ============================
 */

model DailyChallengeProgress {
  userId        String
  
  date          DateTime @db.Date // Uloží len dátum (bez času) pre jednoduché query "dnes"
  matchesPlayed Int      @default(0)
  completed     Boolean  @default(false)
  
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@id([userId, date]) // Jeden záznam na užívateľa na deň
}

model WeeklyStreak {
  userId             String   @id
  
  currentDailyStreak Int      @default(0)
  weekStartDate      DateTime @db.Date
  weekEndDate        DateTime @db.Date
  completed          Boolean  @default(false)
  
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
